-- Simple Floating Script (2025/2026 edition)
-- Press F to toggle floating

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- Settings
local floatEnabled = false
local floatHeight = 8          -- how high above ground to hover
local floatSpeed = 500         -- strength of force (higher = snappier)
local damping = 90             -- prevents bouncing / overshooting
local massCacheTime = 2        -- seconds between mass recalculations
local deadzone = 0.15          -- small deadzone to reduce jitter

-- Objects we create
local attachment = nil
local vectorForce = nil
local connection = nil
local lastMassUpdate = 0
local cachedMass = 0

local function getCharacterMass()
    local mass = 0
    for _, part in character:GetDescendants() do
        if part:IsA("BasePart") or part:IsA("MeshPart") then
            mass = mass + part:GetMass()
        end
    end
    return mass
end

local function setupFloatObjects()
    if vectorForce then vectorForce:Destroy() end
    if attachment then attachment:Destroy() end
    
    attachment = Instance.new("Attachment")
    attachment.Name = "FloatAttachment"
    attachment.Parent = rootPart
    
    vectorForce = Instance.new("VectorForce")
    vectorForce.Name = "FloatForce"
    vectorForce.Attachment0 = attachment
    vectorForce.ApplyAtCenterOfMass = true
    vectorForce.RelativeTo = Enum.ActuatorRelativeTo.World
    vectorForce.Force = Vector3.new(0, 0, 0)
    vectorForce.Parent = rootPart
end

local function startFloating()
    if floatEnabled then return end
    floatEnabled = true
    
    setupFloatObjects()
    cachedMass = getCharacterMass()
    lastMassUpdate = tick()
    
    humanoid.JumpPower = 0
    
    connection = RunService.Heartbeat:Connect(function()
        if not floatEnabled then return end
        
        -- Update mass occasionally (characters can change clothes/tools)
        local now = tick()
        if now - lastMassUpdate > massCacheTime then
            cachedMass = getCharacterMass()
            lastMassUpdate = now
        end
        
        -- Raycast straight down to find ground
        local rayParams = RaycastParams.new()
        rayParams.FilterDescendantsInstances = {character}
        rayParams.FilterType = Enum.RaycastFilterType.Exclude
        
        local rayResult = workspace:Raycast(rootPart.Position, Vector3.new(0, -500, 0), rayParams)
        
        local groundY = rayResult and rayResult.Position.Y or (rootPart.Position.Y - floatHeight)
        local targetY = groundY + floatHeight
        
        local diff = targetY - rootPart.Position.Y
        local velocityY = rootPart.AssemblyLinearVelocity.Y
        
        -- Small deadzone prevents micro-oscillations
        if math.abs(diff) < deadzone and math.abs(velocityY) < 0.4 then
            diff = 0
            velocityY = 0
        end
        
        -- PID-like force: P + D + gravity compensation
        local forceY = cachedMass * (floatSpeed * diff - damping * velocityY + workspace.Gravity)
        
        vectorForce.Force = Vector3.new(0, forceY, 0)
    end)
end

local function stopFloating()
    if not floatEnabled then return end
    floatEnabled = false
    
    if connection then
        connection:Disconnect()
        connection = nil
    end
    
    if vectorForce then
        vectorForce:Destroy()
        vectorForce = nil
    end
    if attachment then
        attachment:Destroy()
        attachment = nil
    end
    
    humanoid.JumpPower = 50  -- default value (you can change this)
end

-- Toggle with F key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.F then
        if floatEnabled then
            stopFloating()
            print("Floating â†’ OFF")
        else
            startFloating()
            print("Floating â†’ ON  (height = " .. floatHeight .. ")")
        end
    end
end)

-- Handle character respawn
player.CharacterAdded:Connect(function(newChar)
    character = newChar
    humanoid = newChar:WaitForChild("Humanoid")
    rootPart = newChar:WaitForChild("HumanoidRootPart")
    
    -- Clean up old stuff
    stopFloating()
    
    -- Re-apply if was enabled
    if floatEnabled then
        task.wait(0.4)
        startFloating()
    end
end)

print("Simple Float Script loaded! Press F to toggle floating.")
